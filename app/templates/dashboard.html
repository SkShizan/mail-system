{% extends "base.html" %}

{% block content %}
<style>
    /* Dashboard specific animations */
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
        100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
    }

    .status-active {
        animation: pulse-glow 2s infinite;
        border-color: var(--status-success) !important;
    }

    .icon-box {
        width: 60px; height: 60px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%;
        background: rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.05);
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease;
    }

    .glass-panel:hover .icon-box {
        transform: scale(1.1) rotate(5deg);
        background: rgba(255,255,255,0.05);
    }
</style>

<!-- Header Section -->
<div class="d-flex flex-wrap justify-content-between align-items-end mb-5">
    <div class="mb-3 mb-md-0">
        <h1 class="display-5 fw-bold text-white mb-1" style="text-shadow: 0 4px 20px rgba(0,0,0,0.5);">
            Dashboard
        </h1>
        <p class="mb-0 text-muted small">
            Real-time system overview and performance metrics.
        </p>
    </div>
    <div>
        <span class="badge rounded-pill px-3 py-2" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--accent-color);">
            <i class="fas fa-circle fa-xs me-2 text-success"></i>System Operational
        </span>
    </div>
</div>

<!-- Stats Grid -->
<div class="row g-4">
    <!-- Sent -->
    <div class="col-12 col-md-6 col-xl-3">
        <div class="glass-panel h-100 p-4 d-flex flex-column align-items-center justify-content-center text-center position-relative overflow-hidden">
            <div class="icon-box" style="color: var(--status-success);">
                <i class="fas fa-paper-plane fa-lg"></i>
            </div>
            <h1 class="display-4 fw-bold text-white mb-1" id="stat-sent">{{ stats.sent }}</h1>
            <div class="stat-label" style="color: var(--status-success);">Emails Sent</div>

            <!-- Background Decoration -->
            <div style="position: absolute; bottom: -20px; right: -20px; font-size: 8rem; opacity: 0.03; color: var(--status-success);">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
    </div>

    <!-- Pending -->
    <div class="col-12 col-md-6 col-xl-3">
        <div class="glass-panel h-100 p-4 d-flex flex-column align-items-center justify-content-center text-center position-relative overflow-hidden">
            <div class="icon-box" style="color: var(--status-wait);">
                <i class="fas fa-clock fa-lg"></i>
            </div>
            <h1 class="display-4 fw-bold text-white mb-1" id="stat-pending">{{ stats.pending }}</h1>
            <div class="stat-label" style="color: var(--status-wait);">Pending</div>

            <div style="position: absolute; bottom: -20px; right: -20px; font-size: 8rem; opacity: 0.03; color: var(--status-wait);">
                <i class="fas fa-clock"></i>
            </div>
        </div>
    </div>

    <!-- Failed -->
    <div class="col-12 col-md-6 col-xl-3">
        <div class="glass-panel h-100 p-4 d-flex flex-column align-items-center justify-content-center text-center position-relative overflow-hidden">
            <div class="icon-box" style="color: var(--status-error);">
                <i class="fas fa-exclamation-triangle fa-lg"></i>
            </div>
            <h1 class="display-4 fw-bold text-white mb-1" id="stat-failed">{{ stats.failed }}</h1>
            <div class="stat-label" style="color: var(--status-error);">Failed</div>

            <div style="position: absolute; bottom: -20px; right: -20px; font-size: 8rem; opacity: 0.03; color: var(--status-error);">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="col-12 col-md-6 col-xl-3">
        <div class="glass-panel h-100 p-4 d-flex flex-column align-items-center justify-content-center text-center position-relative overflow-hidden" id="processing-card">
            <div class="icon-box text-muted" id="processing-icon-box">
                <i class="fas fa-microchip fa-lg" id="processing-icon"></i>
            </div>
            <h1 class="display-6 fw-bold text-white mb-1 text-uppercase" id="stat-processing" style="letter-spacing: 1px;">Idle</h1>
            <div class="stat-label text-muted" id="stat-processing-label">Worker Status</div>

            <div style="position: absolute; bottom: -20px; right: -20px; font-size: 8rem; opacity: 0.03; color: white;">
                <i class="fas fa-microchip"></i>
            </div>
        </div>
    </div>
</div>

<!-- Activity Log Infographics -->
<div class="row mt-5">
    <div class="col-12">
        <div class="glass-panel p-4">
            <div class="d-flex align-items-center mb-4 pb-3 border-bottom" style="border-color: rgba(255,255,255,0.05) !important;">
                <span class="text-accent fw-bold text-uppercase small" style="letter-spacing: 2px;">
                    <i class="fas fa-chart-area me-2"></i>Activity Log & Performance
                </span>
            </div>

            <div class="row g-4">
                <!-- Today's Activity Card -->
                <div class="col-12 col-md-6">
                    <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 0.75rem; padding: 1.5rem;">
                        <h6 class="text-white fw-bold mb-3">üìä Today's Activity</h6>
                        <div class="row g-3">
                            <div class="col-6">
                                <div style="background: rgba(46, 204, 113, 0.1); border-left: 3px solid #2ecc71; padding: 1rem; border-radius: 0.5rem;">
                                    <div class="small text-muted mb-1">Sent Today</div>
                                    <div class="h4 fw-bold text-white" id="today-sent">0</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div style="background: rgba(231, 76, 60, 0.1); border-left: 3px solid #e74c3c; padding: 1rem; border-radius: 0.5rem;">
                                    <div class="small text-muted mb-1">Failed Today</div>
                                    <div class="h4 fw-bold text-white" id="today-failed">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Campaign Card -->
                <div class="col-12 col-md-6">
                    <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 0.75rem; padding: 1.5rem;">
                        <h6 class="text-white fw-bold mb-3">üèÜ Top Campaign</h6>
                        <div style="background: rgba(52, 152, 219, 0.1); border-left: 3px solid #3498db; padding: 1rem; border-radius: 0.5rem;">
                            <div class="small text-muted mb-1">Campaign Name</div>
                            <div class="h5 fw-bold text-white mb-2" id="top-campaign-name">‚Äî</div>
                            <div class="small text-muted">üìß <span id="top-campaign-emails">0</span> total emails</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Campaigns Timeline -->
            <div class="mt-4 pt-4" style="border-top: 1px solid rgba(255,255,255,0.05);">
                <h6 class="text-white fw-bold mb-3">üìß Recent Campaigns (7 Days)</h6>
                <div id="campaigns-timeline" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center text-muted small py-3">Loading...</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Real-time stats refresh with visual feedback
function refreshStats() {
    fetch('/api/stats?v=' + Date.now(), {
        method: 'GET',
        headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('API error');
        return response.json();
    })
    .then(data => {
        const sentEl = document.getElementById('stat-sent');
        const pendingEl = document.getElementById('stat-pending');
        const failedEl = document.getElementById('stat-failed');

        const processingEl = document.getElementById('stat-processing');
        const processingIcon = document.getElementById('processing-icon');
        const processingCard = document.getElementById('processing-card');
        const processingIconBox = document.getElementById('processing-icon-box');
        const processingLabel = document.getElementById('stat-processing-label');

        // Helper for subtle number update animation
        const updateNumber = (el, newVal) => {
            if (el && el.textContent !== String(newVal)) {
                el.style.opacity = 0;
                setTimeout(() => {
                    el.textContent = newVal;
                    el.style.opacity = 1;
                }, 200);
            }
        };

        updateNumber(sentEl, data.sent);
        updateNumber(pendingEl, data.pending);
        updateNumber(failedEl, data.failed);

        // Update processing status visual state
        if (data.processing) {
            processingEl.textContent = 'Running...';
            processingLabel.textContent = 'Worker Active';

            // Apply Active Styles
            processingEl.classList.remove('text-white');
            processingEl.style.color = '#2ecc71'; // Success Green

            processingIcon.className = 'fas fa-cog fa-spin fa-lg';
            processingIconBox.style.color = '#2ecc71';
            processingIconBox.style.background = 'rgba(46, 204, 113, 0.1)';
            processingIconBox.style.borderColor = '#2ecc71';

            processingCard.classList.add('status-active'); // Pulse animation
        } else {
            processingEl.textContent = 'Idle';
            processingLabel.textContent = 'Worker Sleeping';

            // Revert to Idle Styles
            processingEl.classList.add('text-white');
            processingEl.style.color = ''; 

            processingIcon.className = 'fas fa-microchip fa-lg';
            processingIconBox.style.color = ''; // Inherit/Default
            processingIconBox.style.background = '';
            processingIconBox.style.borderColor = '';

            processingCard.classList.remove('status-active');
        }
    })
    .catch(error => {
        console.error('Stats update failed:', error);
    });
}

// Add CSS transition for smooth number updates
const style = document.createElement('style');
style.innerHTML = `
    .dispWorker Sleeping
lay-4 { transition: opacity 0.2s ease-in-out; }
`;
document.head.appendChild(style);

// Activity Log refresh
function refreshActivityLog() {
    fetch('/api/activity-log?v=' + Date.now(), {
        method: 'GET',
        headers: {'Cache-Control': 'no-cache, no-store, must-revalidate'}
    })
    .then(response => response.ok ? response.json() : Promise.reject('API error'))
    .then(data => {
        // Today's activity
        document.getElementById('today-sent').textContent = data.today_activity.sent;
        document.getElementById('today-failed').textContent = data.today_activity.failed;
        
        // Top campaign
        document.getElementById('top-campaign-name').textContent = data.top_campaign.name;
        document.getElementById('top-campaign-emails').textContent = data.top_campaign.total_emails;
        
        // Recent campaigns timeline
        const timeline = document.getElementById('campaigns-timeline');
        if (data.recent_campaigns.length === 0) {
            timeline.innerHTML = '<div class="text-center text-muted small py-3">No campaigns yet</div>';
        } else {
            timeline.innerHTML = data.recent_campaigns.map(c => `
                <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="small fw-bold text-white">${c.name}</div>
                        <div class="tiny text-muted">${c.created_at} ¬∑ ${c.sent} sent</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="background: rgba(46, 204, 113, 0.2); color: #2ecc71; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;">
                            ${c.open_rate}% opened
                        </div>
                    </div>
                </div>
            `).join('');
        }
    })
    .catch(error => console.error('Activity log error:', error));
}

// Refresh immediately on load, then every 2 seconds
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        refreshStats();
        refreshActivityLog();
    });
} else {
    refreshStats();
    refreshActivityLog();
}
setInterval(refreshStats, 2000);
setInterval(refreshActivityLog, 5000);
</script>
{% endblock %}